# MailAgent - Quick Reference

A handy cheat sheet for common MailAgent commands and operations.

## Initial Setup

| Task | Command |
|------|---------|
| Generate secrets and .env | `setup.bat` or `./setup.sh` |
| Verify setup is correct | `verify-setup.bat` or `./verify-setup.sh` |
| Start all services | `docker-compose up -d` |
| Stop all services | `docker-compose down` |
| Start with logs visible | `docker-compose up` |

## Accessing Services

| Service | URL | Purpose |
|---------|-----|---------|
| Frontend | http://localhost:3001 | User interface |
| Backend API | http://localhost:3000 | REST API |
| API Documentation | http://localhost:3000/api/docs | Swagger UI |
| PostgreSQL | localhost:5432 | Database |
| Redis | localhost:6379 | Cache/Queue |
| Nginx | https://localhost | Reverse proxy |

## Test Credentials

**Admin User:**
- Email: `admin@mailagent.local`
- Password: `TestPassword123!`

**Regular User:**
- Email: `test@mailagent.local`
- Password: `UserPassword123!`

**Database:**
- User: `mailuser`
- Password: `mailpass`
- Database: `mailagent`

## Viewing Logs

| Command | Purpose |
|---------|---------|
| `docker-compose logs -f` | View all services (live) |
| `docker-compose logs -f backend` | View backend logs |
| `docker-compose logs -f frontend` | View frontend logs |
| `docker-compose logs -f postgres` | View database logs |
| `docker-compose logs -f redis` | View cache logs |
| `docker-compose logs --tail=50 backend` | View last 50 lines |

## Service Management

| Command | Purpose |
|---------|---------|
| `docker-compose ps` | List all services and status |
| `docker-compose start` | Start stopped services |
| `docker-compose stop` | Stop running services |
| `docker-compose restart backend` | Restart specific service |
| `docker-compose restart` | Restart all services |
| `docker-compose down` | Stop and remove containers |
| `docker-compose down -v` | Stop and remove everything (reset DB) |

## Database Operations

| Command | Purpose |
|---------|---------|
| `docker-compose exec postgres psql -U mailuser -d mailagent` | Open database shell |
| `\dt` | List all tables |
| `\d users` | Describe users table |
| `SELECT * FROM users;` | View all users |
| `SELECT email FROM users WHERE role='admin';` | Find admins |
| `\q` | Exit database shell |

## Redis Operations

| Command | Purpose |
|---------|---------|
| `docker-compose exec redis redis-cli` | Open Redis shell |
| `KEYS *` | List all keys |
| `GET key-name` | Get value of key |
| `DEL key-name` | Delete a key |
| `FLUSHALL` | Clear all data |
| `exit` | Exit Redis shell |

## Rebuild and Deploy

| Command | Purpose |
|---------|---------|
| `docker-compose build` | Rebuild images |
| `docker-compose build --no-cache` | Rebuild without cache |
| `docker-compose build backend` | Rebuild specific service |
| `docker-compose up -d` | Start with latest images |
| `docker-compose pull` | Pull latest base images |

## Configuration

| File | Purpose |
|------|---------|
| `.env` | Environment variables (generated by setup script) |
| `docker-compose.yml` | Service definitions |
| `backend/src/config/configuration.ts` | Centralized config system |
| `backend/prisma/schema.prisma` | Database schema |
| `nginx/nginx.conf` | Reverse proxy configuration |
| `CONFIGURATION.md` | Configuration guide |

## File Structure

```
MailAgent/
├── setup.sh / setup.bat          # Setup script
├── verify-setup.sh / .bat        # Verification script
├── .env                          # Environment variables (auto-generated)
├── docker-compose.yml            # Docker services
├── QUICK_START.md                # 5-minute quick start
├── SETUP_GUIDE.md                # Complete setup guide
├── QUICK_REFERENCE.md            # This file
├── CONFIGURATION.md              # Configuration system details
├── PRIVACY.md                    # GDPR privacy policy
├── README.md                     # Full documentation
│
├── backend/                      # NestJS Backend
│   ├── src/
│   │   ├── config/configuration.ts    # Centralized config
│   │   ├── modules/
│   │   │   ├── auth/                  # Authentication
│   │   │   ├── email/                 # Email integration
│   │   │   ├── ai/                    # Mistral AI
│   │   │   ├── users/                 # User management
│   │   │   ├── tenants/               # Multi-tenancy
│   │   │   └── health/                # Health checks
│   │   └── main.ts                    # Entry point
│   └── prisma/
│       ├── schema.prisma              # Database schema
│       └── seed.ts                    # Database seeding
│
├── frontend/                     # Next.js Frontend
│   ├── pages/
│   │   ├── auth/                      # Login, register
│   │   └── dashboard/                 # Main app
│   ├── components/ui/                 # ShadCN components
│   └── lib/
│       ├── api-client.ts              # API client
│       └── context/                   # React context
│
├── nginx/                        # Reverse Proxy
│   └── nginx.conf
│
└── database/                     # Database Init
    └── init.sql                  # pgvector setup
```

## Useful Snippets

### Check if Port is in Use (macOS/Linux)
```bash
lsof -i :3000
lsof -i :3001
lsof -i :5432
```

### Find Process and Kill It
```bash
kill -9 <PID>
```

### View Docker Disk Usage
```bash
docker system df
```

### Clean Up Docker (Remove unused images/volumes)
```bash
docker system prune -a
```

### Export Database Backup
```bash
docker-compose exec postgres pg_dump -U mailuser -d mailagent > backup.sql
```

### Restore Database from Backup
```bash
docker-compose exec -T postgres psql -U mailuser -d mailagent < backup.sql
```

### Check Backend Health
```bash
curl http://localhost:3000/api/health
```

### Generate New JWT_SECRET
```bash
node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"
```

### Generate New AES_SECRET_KEY
```bash
node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"
```

## Environment Variables (Base Only)

Essential variables in `.env`:

```env
# Development/Production
NODE_ENV=development

# Server
API_PORT=3000
API_HOST=backend

# Database
DB_HOST=postgres
DB_PORT=5432
DB_USER=mailuser
DB_PASSWORD=mailpass
DB_NAME=mailagent

# Redis
REDIS_HOST=redis
REDIS_PORT=6379

# Secrets (generated by setup script)
JWT_SECRET=<generated-automatically>
AES_SECRET_KEY=<generated-automatically>

# External Services (optional for testing)
GMAIL_CLIENT_ID=your_google_client_id # Obtain from Google Cloud Console
MISTRAL_API_KEY=your_mistral_api_key # Obtain from Mistral AI platform
SMTP_HOST=mail-server
```

## Configuration Auto-Build Examples

These are **automatically created** from base variables:

```
DATABASE_URL = postgresql://mailuser:mailpass@postgres:5432/mailagent
REDIS_URL = redis://redis:6379
API_URL = http://backend:3000
GMAIL_REDIRECT_URI = http://backend:3000/auth/gmail/callback
SMTP_FROM = noreply@mailagent.local
```

## Troubleshooting Quick Fixes

| Issue | Solution |
|-------|----------|
| Port in use | Change port in docker-compose.yml |
| DB connection refused | Wait 10s, check `docker-compose ps postgres` |
| AES_SECRET_KEY invalid | Run setup script: `setup.bat` or `./setup.sh` |
| Services not starting | Check logs: `docker-compose logs` |
| OTP not received | Check logs: `docker-compose logs backend \| grep OTP` |
| Frontend blank page | Hard refresh: Ctrl+F5 (Cmd+Shift+R on Mac) |
| API docs showing error | Wait for backend startup: `docker-compose logs backend` |

## Important Files to Review

1. **[CONFIGURATION.md](CONFIGURATION.md)** - How the config system works
2. **[SETUP_GUIDE.md](SETUP_GUIDE.md)** - Complete step-by-step setup
3. **[QUICK_START.md](QUICK_START.md)** - 5-minute quick start
4. **[README.md](README.md)** - Full documentation and API reference
5. **[PRIVACY.md](PRIVACY.md)** - GDPR and privacy details

## Useful Links

- **Documentation**: See `.md` files in project root
- **API Docs**: http://localhost:3000/api/docs (when running)
- **Nginx Config**: `nginx/nginx.conf`
- **Database Schema**: `backend/prisma/schema.prisma`
- **Backend Config**: `backend/src/config/configuration.ts`

## Release Notes / Version Info

- **Node.js**: 18+ required
- **PostgreSQL**: 15+ with pgvector extension
- **Redis**: Latest
- **NestJS**: Latest version
- **Next.js**: Latest version
- **Docker**: 20.10+ with Docker Compose

---

**Pro Tips:**
- Use `docker-compose ps` before debugging to check service status
- Check logs first: `docker-compose logs service-name`
- Keep `.env` secure - never commit to git
- Generate new secrets for production
- Use `verify-setup.sh` after major changes

---

**Last updated**: January 2025
