// Prisma schema for MailAgent multi-tenant system

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== TENANT MODEL =====
model Tenant {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  description String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  // Relations
  users           User[]
  messages        Message[]
  providerConfigs ProviderConfig[]
  emails          Email[]
  embeddings      Embedding[]
  auditLogs       AuditLog[]
  chatSessions    ChatSession[]
  calendarEvents  CalendarEvent[]

  @@map("tenants")
}

// ===== USER MODEL =====
model User {
  id           String    @id @default(cuid())
  tenantId     String
  email        String
  passwordHash String
  firstName    String?
  lastName     String?
  role         String    @default("user") // "admin", "user", "super-admin"
  isActive     Boolean   @default(true)
  isMfaEnabled Boolean   @default(true)
  lastLogin    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  // Relations
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  mfaCodes     MfaCode[]
  sessions     Session[]
  messages     Message[]
  auditLogs    AuditLog[]
  chatSessions ChatSession[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@map("users")
}

// ===== MFA CODE MODEL =====
model MfaCode {
  id        String   @id @default(cuid())
  userId    String
  code      String   @unique
  type      String   @default("email") // "email", "sms"
  isUsed    Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, code])
  @@map("mfa_codes")
}

// ===== SESSION MODEL =====
model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, token])
  @@map("sessions")
}

// ===== PASSWORD RESET TOKEN =====
model PasswordResetToken {
  id        String   @id @default(cuid())
  userEmail String
  token     String   @unique
  tenantId  String
  isUsed    Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("password_reset_tokens")
}

// ===== PROVIDER CONFIG MODEL (Email + Calendar) =====
model ProviderConfig {
  id           String  @id @default(cuid())
  tenantId     String
  userId       String?
  providerType String // "google", "microsoft", "generic"
  email        String
  displayName  String?

  // Capabilities (what this provider supports)
  supportsEmail    Boolean @default(true)
  supportsCalendar Boolean @default(false)
  supportsContacts Boolean @default(false)

  // OAuth2 tokens (for Google/Microsoft) - Encrypted
  accessToken              String?
  refreshToken             String?
  tokenEncryptionIv        String? // IV for token encryption
  refreshTokenEncryptionIv String? // IV for refresh token encryption
  tokenExpiresAt           DateTime?

  // IMAP/SMTP configuration (for generic providers)
  imapHost         String?
  imapPort         Int?
  imapUsername     String?
  imapPassword     String? // Encrypted
  imapEncryptionIv String? // IV for IMAP password
  imapUseTls       Boolean @default(true)

  smtpHost         String?
  smtpPort         Int?
  smtpUsername     String?
  smtpPassword     String? // Encrypted
  smtpEncryptionIv String? // IV for SMTP password
  smtpUseTls       Boolean @default(true)

  // CalDAV/CardDAV configuration (for generic providers)
  caldavUrl          String?
  caldavUsername     String?
  caldavPassword     String? // Encrypted
  caldavEncryptionIv String? // IV for CalDAV password

  carddavUrl          String?
  carddavUsername     String?
  carddavPassword     String? // Encrypted
  carddavEncryptionIv String? // IV for CardDAV password

  // Metadata
  metadata     Json? // Additional provider-specific settings
  isDefault    Boolean   @default(false)
  isActive     Boolean   @default(true)
  lastSyncedAt DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Smart Sync - Intelligent Synchronization Fields
  avgActivityRate       Float?    @default(0.0) // Average emails per hour (moving average)
  syncPriority          Int?      @default(3) // 1=High, 2-3=Medium, 4-5=Low
  nextSyncAt            DateTime? // When to schedule next sync
  emailsReceivedLast24h Int?      @default(0) // Counter for activity tracking
  errorStreak           Int?      @default(0) // Consecutive sync errors (for monitoring)
  lastActivityCheck     DateTime? // Last time activity rate was calculated

  // Relations
  tenant        Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  emails        Email[]
  calendarEvents CalendarEvent[]

  @@unique([tenantId, email, providerType])
  @@index([tenantId, isDefault])
  @@index([userId])
  @@index([nextSyncAt, isActive]) // For scheduler queries
  @@index([syncPriority, nextSyncAt]) // For priority-based scheduling
  @@map("provider_configs")
}

// ===== EMAIL MODEL (Synced emails from providers) =====
model Email {
  id         String @id @default(cuid())
  tenantId   String
  providerId String

  // External IDs for sync tracking
  externalId String // Gmail messageId, Microsoft ID, IMAP UID
  threadId   String? // For conversation threading

  // Email metadata
  messageId  String? // RFC 2822 Message-ID header
  inReplyTo  String? // RFC 2822 In-Reply-To header
  references String? // RFC 2822 References header

  // Sender and recipients
  from    String // "Name <email@domain.com>"
  to      String[] // Array of recipients
  cc      String[] @default([])
  bcc     String[] @default([])
  replyTo String?

  // Content
  subject  String
  bodyText String? // Plain text version
  bodyHtml String? // HTML version
  snippet  String? // Preview/summary (first 200 chars)

  // Classification
  folder String   @default("INBOX") // INBOX, SENT, DRAFTS, TRASH, etc.
  labels String[] @default([]) // Gmail labels or categories

  // Flags and status
  isRead     Boolean @default(false)
  isStarred  Boolean @default(false)
  isFlagged  Boolean @default(false)
  isDraft    Boolean @default(false)
  isDeleted  Boolean @default(false)
  isArchived Boolean @default(false) // Archived emails have body removed but keep ID + embeddings

  // Dates
  sentAt     DateTime // When email was sent
  receivedAt DateTime // When email was received
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Size
  size Int? // Size in bytes

  // Metadata
  headers  Json? // Full email headers
  metadata Json? // Provider-specific metadata

  // Cross-provider sync
  crossProviderLinkId String? // Link to cross-provider group

  // Relations
  tenant              Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  provider            ProviderConfig           @relation(fields: [providerId], references: [id], onDelete: Cascade)
  attachments         EmailAttachment[]
  crossProviderLink   EmailCrossProviderLink?  @relation(fields: [crossProviderLinkId], references: [id], onDelete: SetNull)

  @@unique([providerId, externalId]) // Prevent duplicates
  @@unique([tenantId, messageId])
  @@index([tenantId, folder, receivedAt]) // List emails by folder
  @@index([tenantId, isRead]) // Unread emails
  @@index([tenantId, threadId]) // Thread grouping
  @@index([sentAt]) // Sort by date
  @@index([crossProviderLinkId]) // Cross-provider lookups
  @@map("emails")
}

// ===== EMAIL ATTACHMENT MODEL =====
model EmailAttachment {
  id      String @id @default(cuid())
  emailId String

  // Attachment metadata
  filename  String
  mimeType  String
  size      Int // Size in bytes
  contentId String? // For inline images

  // Storage
  storageType String  @default("local") // "local", "s3", "azure"
  storagePath String? // Path to file on disk or cloud

  // Inline flag
  isInline Boolean @default(false)

  createdAt DateTime @default(now())

  // Relations
  email Email @relation(fields: [emailId], references: [id], onDelete: Cascade)

  @@index([emailId])
  @@map("email_attachments")
}

// ===== CROSS-PROVIDER EMAIL LINK MODEL =====
// Links the same email across multiple providers (e.g., Gmail + Outlook)
model EmailCrossProviderLink {
  id       String @id @default(cuid())
  tenantId String

  // Content hash for deduplication (SHA-256 of messageId + subject + sentAt)
  contentHash String

  // Conflict resolution strategy for this link
  conflictStrategy String @default("LAST_WRITE_WINS") // "LAST_WRITE_WINS", "UNION", "INTERSECTION", "PRIORITY_BASED"

  // Merged state across all providers (computed from provider states)
  mergedIsRead     Boolean   @default(false)
  mergedIsStarred  Boolean   @default(false)
  mergedFolder     String    @default("INBOX")
  mergedLabels     String[]  @default([])

  // Tracking
  providerCount    Int       @default(0) // How many providers have this email
  lastSyncedAt     DateTime  @default(now())
  lastConflictAt   DateTime? // Last time a conflict was detected

  // Conflict metadata (JSON with details about last conflict)
  lastConflict     Json?

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  emails Email[] // All emails linked to this group

  @@unique([tenantId, contentHash]) // One link per unique email per tenant
  @@index([tenantId, lastSyncedAt])
  @@index([contentHash])
  @@map("email_cross_provider_links")
}

// Update Tenant model to include emails relation
// (Already exists, just documenting)

// ===== MESSAGE MODEL =====
model Message {
  id             String   @id @default(cuid())
  tenantId       String
  userId         String
  conversationId String?
  role           String // "user", "assistant"
  content        String
  embeddingId    String?
  isDeleted      Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  embedding Embedding? @relation(fields: [embeddingId], references: [id])

  @@index([tenantId, userId, conversationId])
  @@index([createdAt])
  @@map("messages")
}

model ChatSession {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  title     String
  messages  Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId, userId, updatedAt])
  @@map("chat_sessions")
}

// ===== EMBEDDING MODEL (PGVECTOR) =====
model Embedding {
  id             String                 @id @default(cuid())
  tenantId       String
  messageId      String?
  documentName   String?
  content        String
  vector         Unsupported("vector")? // pgvector type
  embeddingModel String                 @default("mistral-embed")
  metadata       Json?
  createdAt      DateTime               @default(now())

  // Relations
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([tenantId])
  @@map("embeddings")
}

// ===== CALENDAR EVENT MODEL (Synced calendar events from providers) =====
model CalendarEvent {
  id         String @id @default(cuid())
  tenantId   String
  providerId String

  // External IDs for sync tracking
  externalId String // Google event ID, Microsoft event ID
  calendarId String? // Which calendar this event belongs to
  calendarName String? // Friendly calendar name

  // Event metadata
  iCalUID    String? // RFC 5545 UID (for cross-provider sync)

  // Event details
  title       String // Event title/summary
  description String? // Event description/body
  location    String? // Event location

  // Attendees
  organizer  String? // Organizer email
  attendees  Json? // Array of attendees with status

  // Time and recurrence
  startTime    DateTime // Event start time
  endTime      DateTime // Event end time
  isAllDay     Boolean  @default(false)
  timeZone     String   @default("UTC")
  recurrence   String[] @default([]) // RRULE strings
  recurringEventId String? // ID of parent recurring event

  // Status and flags
  status       String  @default("confirmed") // confirmed, tentative, cancelled
  visibility   String  @default("default") // default, public, private, confidential
  isDeleted    Boolean @default(false)
  isCancelled  Boolean @default(false)

  // Reminders
  reminders    Json? // Reminder settings

  // Dates
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Metadata
  metadata     Json? // Provider-specific metadata
  htmlLink     String? // Link to event in provider's UI

  // Sync tracking
  lastSyncedAt DateTime @default(now())
  syncVersion  Int      @default(1) // Increment on each update for conflict resolution

  // Relations
  tenant   Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  provider ProviderConfig @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, externalId]) // Prevent duplicates
  @@index([tenantId, startTime]) // List events by date
  @@index([tenantId, calendarId, startTime]) // List events in a calendar
  @@index([iCalUID]) // Cross-provider sync
  @@map("calendar_events")
}

// ===== AUDIT LOG MODEL =====
model AuditLog {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String?
  action    String // "CREATE", "UPDATE", "DELETE"
  entity    String // "User", "Message", "ProviderConfig"
  entityId  String
  changes   Json?
  ipAddress String?
  createdAt DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId, createdAt])
  @@index([userId, createdAt])
  @@map("audit_logs")
}

// ===== JOB QUEUE MODEL (for tracking BullMQ jobs) =====
model JobQueue {
  id          String    @id @default(cuid())
  tenantId    String
  jobId       String
  jobType     String // "email_sync", "ai_processing", "embedding"
  status      String    @default("pending") // "pending", "running", "completed", "failed"
  data        Json
  result      Json?
  error       String?
  retries     Int       @default(0)
  maxRetries  Int       @default(3)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  @@index([tenantId, status])
  @@index([createdAt])
  @@map("job_queue")
}

// ===== WEBHOOK SUBSCRIPTION MODEL (for real-time sync) =====
model WebhookSubscription {
  id             String   @id @default(cuid())
  providerId     String   @unique // One webhook per provider
  providerType   String // "google", "microsoft"

  // Provider-specific subscription ID
  subscriptionId String // Gmail historyId, Microsoft subscription ID

  // Webhook details
  webhookUrl     String? // For Microsoft Graph
  resourcePath   String? // Resource being watched

  // Lifecycle
  isActive       Boolean  @default(true)
  expiresAt      DateTime // When subscription expires
  lastRenewedAt  DateTime @default(now())

  // Metadata
  metadata       Json? // Provider-specific data (topic name, etc.)

  // Tracking
  lastNotificationAt DateTime?
  notificationCount  Int       @default(0)
  errorCount         Int       @default(0)
  lastError          String?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([providerId, isActive])
  @@index([expiresAt]) // For renewal queries
  @@index([providerType])
  @@map("webhook_subscriptions")
}

// ===== HEALTH CHECK =====
model HealthCheck {
  id            String   @id @default(cuid())
  service       String // "database", "redis", "mistral", "email"
  status        String   @default("up") // "up", "down", "degraded"
  lastCheckedAt DateTime @default(now())
  responseTime  Int? // milliseconds
  error         String?

  @@unique([service])
  @@map("health_checks")
}
