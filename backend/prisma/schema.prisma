generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id                   String                @id @default(cuid())
  name                 String
  slug                 String                @unique
  description          String?
  isActive             Boolean               @default(true)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  deletedAt            DateTime?
  auditLogs            AuditLog[]
  calendarEvents       CalendarEvent[]
  chatSessions         ChatSession[]
  contacts             Contact[]
  emails               Email[]
  embeddings           Embedding[]
  folders              Folder[]
  messages             Message[]
  providerConfigs      ProviderConfig[]
  users                User[]
  webhookSubscriptions WebhookSubscription[]

  @@map("tenants")
}

model User {
  id           String        @id @default(cuid())
  tenantId     String
  email        String
  passwordHash String
  firstName    String?
  lastName     String?
  role         String        @default("user")
  isActive     Boolean       @default(true)
  isMfaEnabled Boolean       @default(true)
  lastLogin    DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  deletedAt    DateTime?
  auditLogs    AuditLog[]
  chatSessions ChatSession[]
  messages     Message[]
  mfaCodes     MfaCode[]
  sessions     Session[]
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, email])
  @@index([tenantId])
  @@map("users")
}

model MfaCode {
  id        String   @id @default(cuid())
  userId    String
  code      String   @unique
  type      String   @default("email")
  isUsed    Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, code])
  @@map("mfa_codes")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, token])
  @@map("sessions")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userEmail String
  token     String   @unique
  tenantId  String
  isUsed    Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("password_reset_tokens")
}

model ProviderConfig {
  id                       String                @id @default(cuid())
  tenantId                 String
  userId                   String?
  providerType             String
  email                    String
  displayName              String?
  supportsEmail            Boolean               @default(true)
  supportsCalendar         Boolean               @default(false)
  supportsContacts         Boolean               @default(false)
  accessToken              String?
  refreshToken             String?
  tokenEncryptionIv        String?
  tokenExpiresAt           DateTime?
  imapHost                 String?
  imapPort                 Int?
  imapUsername             String?
  imapPassword             String?
  imapEncryptionIv         String?
  imapUseTls               Boolean               @default(true)
  smtpHost                 String?
  smtpPort                 Int?
  smtpUsername             String?
  smtpPassword             String?
  smtpEncryptionIv         String?
  smtpUseTls               Boolean               @default(true)
  caldavUrl                String?
  caldavUsername           String?
  caldavPassword           String?
  caldavEncryptionIv       String?
  carddavUrl               String?
  carddavUsername          String?
  carddavPassword          String?
  carddavEncryptionIv      String?
  metadata                 Json?
  isDefault                Boolean               @default(false)
  isActive                 Boolean               @default(true)
  lastSyncedAt             DateTime?
  createdAt                DateTime              @default(now())
  updatedAt                DateTime              @updatedAt
  avgActivityRate          Float?                @default(0.0)
  syncPriority             Int?                  @default(3)
  nextSyncAt               DateTime?
  emailsReceivedLast24h    Int?                  @default(0)
  errorStreak              Int?                  @default(0)
  lastActivityCheck        DateTime?
  refreshTokenEncryptionIv String?
  calendarEvents           CalendarEvent[]
  contacts                 Contact[]
  emails                   Email[]
  folders                  Folder[]
  tenant                   Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  webhookSubscriptions     WebhookSubscription[]

  @@unique([tenantId, email, providerType])
  @@index([tenantId, isDefault])
  @@index([userId])
  @@index([nextSyncAt, isActive])
  @@index([syncPriority, nextSyncAt])
  @@map("provider_configs")
}

model Email {
  id                  String                  @id @default(cuid())
  tenantId            String
  providerId          String
  externalId          String
  threadId            String?
  messageId           String?
  inReplyTo           String?
  references          String?
  from                String
  to                  String[]
  cc                  String[]                @default([])
  bcc                 String[]                @default([])
  replyTo             String?
  subject             String
  bodyText            String?
  bodyHtml            String?
  snippet             String?
  folder              String                  @default("INBOX")
  labels              String[]                @default([])
  isRead              Boolean                 @default(false)
  isStarred           Boolean                 @default(false)
  isFlagged           Boolean                 @default(false)
  isDraft             Boolean                 @default(false)
  isDeleted           Boolean                 @default(false)
  isArchived          Boolean                 @default(false)
  sentAt              DateTime
  receivedAt          DateTime
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  size                Int?
  headers             Json?
  metadata            Json?
  crossProviderLinkId String?
  attachments         EmailAttachment[]
  crossProviderLink   EmailCrossProviderLink? @relation(fields: [crossProviderLinkId], references: [id])
  provider            ProviderConfig          @relation(fields: [providerId], references: [id], onDelete: Cascade)
  tenant              Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([providerId, externalId])
  @@unique([tenantId, messageId])
  @@index([tenantId, folder, receivedAt])
  @@index([tenantId, isRead])
  @@index([tenantId, threadId])
  @@index([sentAt])
  @@index([crossProviderLinkId])
  @@map("emails")
}

model Folder {
  id           String         @id @default(cuid())
  tenantId     String
  providerId   String
  name         String
  path         String
  externalId   String?
  delimiter    String         @default("/")
  parentId     String?
  level        Int            @default(0)
  isSelectable Boolean        @default(true)
  specialUse   String?
  attributes   String[]       @default([])
  totalCount   Int            @default(0)
  unreadCount  Int            @default(0)
  recentCount  Int            @default(0)
  unseenCount  Int            @default(0)
  uidValidity  String?
  uidNext      Int?           @default(0)
  syncToken    String?
  lastSyncedAt DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  parent       Folder?        @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children     Folder[]       @relation("FolderHierarchy")
  provider     ProviderConfig @relation(fields: [providerId], references: [id], onDelete: Cascade)
  tenant       Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([providerId, path])
  @@index([providerId, externalId])
  @@index([tenantId, providerId])
  @@index([tenantId, specialUse])
  @@index([providerId, parentId])
  @@index([lastSyncedAt])
  @@map("folders")
}

model EmailAttachment {
  id          String   @id @default(cuid())
  emailId     String
  filename    String
  mimeType    String
  size        Int
  contentId   String?
  storageType String   @default("local")
  storagePath String?
  isInline    Boolean  @default(false)
  createdAt   DateTime @default(now())
  email       Email    @relation(fields: [emailId], references: [id], onDelete: Cascade)

  @@index([emailId])
  @@map("email_attachments")
}

model EmailCrossProviderLink {
  id               String    @id @default(cuid())
  tenantId         String
  contentHash      String
  conflictStrategy String    @default("LAST_WRITE_WINS")
  mergedIsRead     Boolean   @default(false)
  mergedIsStarred  Boolean   @default(false)
  mergedFolder     String    @default("INBOX")
  mergedLabels     String[]  @default([])
  providerCount    Int       @default(0)
  lastSyncedAt     DateTime  @default(now())
  lastConflictAt   DateTime?
  lastConflict     Json?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  emails           Email[]

  @@unique([tenantId, contentHash])
  @@index([tenantId, lastSyncedAt])
  @@index([contentHash])
  @@map("email_cross_provider_links")
}

model Message {
  id             String     @id @default(cuid())
  tenantId       String
  userId         String
  conversationId String?
  role           String
  content        String
  embeddingId    String?
  isDeleted      Boolean    @default(false)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  embedding      Embedding? @relation(fields: [embeddingId], references: [id])
  tenant         Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId, userId, conversationId])
  @@index([createdAt])
  @@map("messages")
}

model ChatSession {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  title     String
  messages  Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId, userId, updatedAt])
  @@map("chat_sessions")
}

model Embedding {
  id             String                 @id @default(cuid())
  tenantId       String
  messageId      String?
  documentName   String?
  content        String
  vector         Unsupported("vector")?
  embeddingModel String                 @default("mistral-embed")
  metadata       Json?
  createdAt      DateTime               @default(now())
  tenant         Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  messages       Message[]

  @@index([tenantId])
  @@map("embeddings")
}

model CalendarEvent {
  id               String         @id @default(cuid())
  tenantId         String
  providerId       String
  externalId       String
  calendarId       String?
  iCalUID          String?
  title            String
  description      String?
  location         String?
  organizer        String?
  attendees        Json?
  startTime        DateTime
  endTime          DateTime
  isAllDay         Boolean        @default(false)
  timeZone         String         @default("UTC")
  recurrence       String[]       @default([])
  recurringEventId String?
  status           String         @default("confirmed")
  visibility       String         @default("default")
  isDeleted        Boolean        @default(false)
  isCancelled      Boolean        @default(false)
  reminders        Json?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  metadata         Json?
  htmlLink         String?
  lastSyncedAt     DateTime       @default(now())
  syncVersion      Int            @default(1)
  calendarName     String?
  provider         ProviderConfig @relation(fields: [providerId], references: [id], onDelete: Cascade)
  tenant           Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([providerId, externalId])
  @@index([tenantId, startTime])
  @@index([tenantId, calendarId, startTime])
  @@index([iCalUID])
  @@map("calendar_events")
}

model Contact {
  id             String         @id @default(cuid())
  tenantId       String
  providerId     String
  externalId     String
  contactGroup   String?
  firstName      String?
  lastName       String?
  middleName     String?
  displayName    String?
  nickname       String?
  prefix         String?
  suffix         String?
  emails         Json?
  phoneNumbers   Json?
  addresses      Json?
  company        String?
  jobTitle       String?
  department     String?
  birthday       DateTime?
  anniversary    DateTime?
  websites       Json?
  socialProfiles Json?
  notes          String?
  photoUrl       String?
  photoEtag      String?
  isDeleted      Boolean        @default(false)
  isStarred      Boolean        @default(false)
  isFavorite     Boolean        @default(false)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  metadata       Json?
  vCardVersion   String?        @default("4.0")
  lastSyncedAt   DateTime       @default(now())
  syncVersion    Int            @default(1)
  eTag           String?
  provider       ProviderConfig @relation(fields: [providerId], references: [id], onDelete: Cascade)
  tenant         Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([providerId, externalId])
  @@index([tenantId, lastName, firstName])
  @@index([tenantId, displayName])
  @@index([tenantId, company])
  @@index([contactGroup])
  @@map("contacts")
}

model AuditLog {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String?
  action    String
  entity    String
  entityId  String
  changes   Json?
  ipAddress String?
  createdAt DateTime @default(now())
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id])

  @@index([tenantId, createdAt])
  @@index([userId, createdAt])
  @@map("audit_logs")
}

model JobQueue {
  id          String    @id @default(cuid())
  tenantId    String
  jobId       String
  jobType     String
  status      String    @default("pending")
  data        Json
  result      Json?
  error       String?
  retries     Int       @default(0)
  maxRetries  Int       @default(3)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  @@index([tenantId, status])
  @@index([createdAt])
  @@map("job_queue")
}

model WebhookSubscription {
  id                 String         @id @default(cuid())
  providerId         String
  providerType       String
  subscriptionId     String
  webhookUrl         String?
  resourcePath       String         @default("generic")
  isActive           Boolean        @default(true)
  expiresAt          DateTime
  lastRenewedAt      DateTime       @default(now())
  metadata           Json?
  lastNotificationAt DateTime?
  notificationCount  Int            @default(0)
  errorCount         Int            @default(0)
  lastError          String?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  tenantId           String
  provider           ProviderConfig @relation(fields: [providerId], references: [id], onDelete: Cascade)
  tenant             Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([providerId, resourcePath])
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@index([providerId, isActive])
  @@index([expiresAt])
  @@index([providerType])
  @@index([subscriptionId])
  @@map("webhook_subscriptions")
}

model HealthCheck {
  id            String   @id @default(cuid())
  service       String   @unique
  status        String   @default("up")
  lastCheckedAt DateTime @default(now())
  responseTime  Int?
  error         String?

  @@map("health_checks")
}
